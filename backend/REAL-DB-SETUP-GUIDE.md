# 真实数据库认证配置指南

本指南将帮助您配置系统使用MongoDB数据库中的真实数据进行用户认证，而不是使用模拟数据。

## 系统变更说明

我们已经对`authController.js`进行了以下关键修改，以优先使用真实数据库：

1. **默认使用真实数据库模式**：系统启动时会自动尝试连接并使用真实数据库
2. **移除环境变量依赖**：不再需要设置`USE_REAL_DB`环境变量
3. **异步初始化**：认证模块使用异步方式初始化，确保数据库连接完成后再进行操作
4. **更详细的日志输出**：添加了详细的日志，帮助您监控系统状态和诊断问题

## 前提条件

在开始之前，请确保您已满足以下条件：

1. **MongoDB服务已安装并运行**
2. **已创建名为`quant_trading_platform`的数据库**（或根据您的配置使用其他名称）
3. **Node.js环境已配置正确**
4. **后端服务的依赖已安装**（可通过`npm install`命令安装）

## 配置步骤

### 步骤1：确认数据库连接配置

检查`src/index.js`文件中的数据库连接配置，确保连接字符串正确：

```javascript
// MongoDB连接配置示例
const mongoURI = process.env.MONGO_URI || 'mongodb://localhost:27017/quant_trading_platform';
```

您可以通过环境变量`MONGO_URI`自定义连接字符串，或者直接修改代码中的默认值。

### 步骤2：确保User模型已正确定义

检查`src/models/User.js`文件，确保User模型已正确定义并且包含`comparePassword`方法。如果没有，系统会自动添加该方法。

### 步骤3：在数据库中创建用户

在MongoDB数据库中创建测试用户。您可以使用MongoDB Compass、Mongo Shell或其他工具来执行此操作。

以下是创建管理员用户和普通用户的示例：

**管理员用户**：
```javascript
// 注意：密码必须是bcrypt哈希值
// 以下是admin123的示例哈希值（仅用于测试）
db.users.insertOne({
  username: "admin",
  email: "admin@example.com",
  password: "$2a$10$F3Q2T3sX4y5u6i7o8p9a0sdfghjklzxcvbnmASDFGHJK", // 密码: admin123
  role: "admin",
  balance: 100000,
  createdAt: new Date()
});
```

**普通用户**：
```javascript
db.users.insertOne({
  username: "user1",
  email: "user1@example.com",
  password: "$2a$10$B3N2M3sX4y5u6i7o8p9a0sdfghjklzxcvbnmASDFGHJK", // 密码: user123
  role: "user",
  balance: 50000,
  createdAt: new Date()
});
```

### 步骤4：启动后端服务

使用以下命令启动后端服务：

```bash
npm start
# 或使用开发模式
npm run dev
```

观察控制台输出，确认服务已成功启动并且认证模块使用了真实数据库模式：

```
认证模块初始化...
正在尝试加载真实数据库模型...
MongoDB已连接，尝试加载真实User模型...
成功加载已注册的User模型
已添加comparePassword静态方法
真实数据库模型加载成功
认证模块初始化完成 - 使用真实数据库模式
```

## 验证方法

我们提供了一个专用的测试脚本来验证系统是否正确使用数据库进行认证：

```bash
node test-real-db-auth.js
```

该脚本会：
1. 检查后端服务是否运行
2. 分析系统当前的运行模式（真实数据库或模拟数据）
3. 尝试使用预设的用户凭证登录
4. 提供详细的测试结果和进一步的验证建议

## 可能的问题及解决方案

### 问题1：系统仍使用模拟数据模式

**症状**：测试脚本显示系统仍在使用模拟数据模式

**解决方案**：
- 检查MongoDB服务是否正在运行
- 确认数据库连接字符串正确
- 检查`quant_trading_platform`数据库是否存在
- 查看服务器日志，检查是否有数据库连接错误

### 问题2：用户登录失败

**症状**：使用正确的凭证登录失败

**解决方案**：
- 确认数据库中存在该用户
- 检查密码是否正确（包括大小写）
- 验证密码是否使用bcrypt进行了正确哈希
- 检查用户角色是否正确设置

### 问题3：初始化过程中出现错误

**症状**：控制台显示初始化错误

**解决方案**：
- 检查User模型定义是否正确
- 确认数据库权限设置正确
- 查看详细的错误日志以确定具体问题

## 模拟数据模式作为后备

即使我们优先使用真实数据库，系统也会在以下情况自动回退到模拟数据模式：

1. MongoDB服务未运行
2. 数据库连接失败
3. User模型加载失败

这样可以确保系统在任何情况下都能正常运行，不会因为数据库问题而完全无法使用。

## 进一步验证建议

为了彻底验证系统是否正确使用数据库进行认证，建议执行以下操作：

1. 在MongoDB中添加一个全新的用户，然后使用该用户凭证登录
2. 修改现有用户的密码（使用bcrypt重新哈希），然后验证更新后可以正常登录
3. 在不同的环境中测试认证功能，确保一致性
4. 检查系统日志，确认所有认证操作都记录正确

通过遵循本指南，您可以确保系统正确使用MongoDB数据库中的真实数据进行用户认证，提高系统的安全性和可靠性。